from lib.GE_SRTP import *
import time
import json
import builtins

# PLC IP address
plc_ip = '4.120.143.1'

# PLC tags
plc_tags = {
    # "encoder": "R7354",
    # "line speed": "R5032",
    "moving": "Q0065",
}

# Buffer print function that logs to a file
def print_and_log(content):
    with open("nissan-ge--12-00--7-may.log", "a") as file:
        print(content, file=file, flush=True)
    print(content)

# Function to connect to the PLC
def connect_to_plc(ip):
    plc = GeSrtp(ip)
    plc.initConnection()
    return plc

def parse_tag_data(data, data_type):
    parsed_data = ''
    if data_type == 'int array':
        for d in data:
            parsed_data += chr(d)
    elif data_type == 'byte_string':
        decoded_string = data.decode("utf-8", "ignore")
        parsed_data = ''.join(char for char in decoded_string if char.isprintable())
    else:
        parsed_data = data
    return parsed_data

# Function to read tags from the PLC
def read_tags(plc, tags):
    values = {}
    for tag_name, tag_address in tags.items():
        print_and_log(f'READING: {tag_address}')
        res = plc.readSysMemory(tag_address)
        print_and_log(f'RES: {res.register_result}\n\n')
        values[tag_name] = res.register_result
        # if isinstance(values[tag_name], bytes):
        #     values[tag_name] = parse_tag_data(values[tag_name], 'byte_string')
    return values

# Main script
def main():
    plc = connect_to_plc(plc_ip)
    last_values = {}

    while True:
        try:
            current_values = read_tags(plc, plc_tags)
            curr_ts = int(time.time()*1e3)
            for tag, value in current_values.items():
                if tag not in last_values or last_values[tag] != value:
                    print_and_log(f"{tag} tag '{plc_tags[tag]}' changed to {value} at: {float(curr_ts) / 1e3}")
            last_values = current_values
            time.sleep(1)
        except KeyboardInterrupt:
            print_and_log("Exiting...")
            break
        except Exception as e:
            print_and_log(f"Error: {e}")
            break

if __name__ == "__main__":
    main()

#  0    1    2    3    4    5    6    7    8    9    10   11   12   13   14   15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30   31   32   33   34   35   36   37   38   39   40   41   42     43   44   45   46   47   48     49   50   51   52   53   54  55
# Bit (shift live)
# 0x03 0x00 0x06 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x01 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x06 0xd4 0x10 0x0e 0x00 0x00 0x00 0x4c 0x00 0x00 0x01 0x01 0x00 | 0x00 0x01 0x00 0x00 0x00 0x00 | 0x00 0xff 0x02 0xb9 0x00 0x7c 0x01
# Bit (shift ended)
# 0x03 0x00 0x06 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x01 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x06 0xd4 0x10 0x0e 0x00 0x00 0x00 0x48 0x00 0x00 0x01 0x01 0x00 | 0x00 0x01 0x00 0x00 0x00 0x00 | 0x00 0xff 0x02 0xb8 0x00 0x7c 0x01

# Byte (shift live)
# 0x03 0x00 0x06 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x01 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x06 0xd4 0x10 0x0e 0x00 0x00 0x00 0x48 0x00 0x00 0x01 0x01 0x00 | 0x00 0x00 0x00 0x00 0x00 0x00 | 0x00 0xff 0x02 0xb4 0x00 0x7c 0x01
# Byte (shift ended)
# 0x03 0x00 0x06 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x01 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x06 0xd4 0x10 0x0e 0x00 0x00 0x00 0x48 0x00 0x00 0x01 0x01 0x00 | 0x00 0x00 0x00 0x00 0x00 0x00 | 0x00 0xff 0x02 0xb9 0x00 0x7c 0x01
